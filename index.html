<!DOCTYPE html>
<html>

<head>
  <title>write a poem</title>
  <meta charset="UTF-8">
  <link rel="shortcut icon" href="favicon.png"/>
  <style>
    body {
      margin: 0px;
      width: 100vw;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      background: black;
      transition: filter 0.1s;
    }

    #container {
      position: absolute;
      display: inherit;
      justify-content: inherit;
      align-items: inherit;
      width: calc(100% - 400px);
      height: calc(100% - 200px);
      overflow: scroll;
    }

    p {
      position: absolute;
      max-width: 100%;
      max-height: 100%;
      margin: 0px;
      text-align: justify;
      font-family: 'Courier';
      font-style: italic;
      font-size: 30px;
      letter-spacing: 3px;
      transition: transform 0.1s, color 0.1s;
      mix-blend-mode: color-dodge;
    }

    @keyframes blink {
      from { opacity: 0; }
      to   { opacity: 1; }
    }

    .cursor {
      animation: blink 0.5s ease infinite alternate;
    }

    ::-webkit-scrollbar {
      display: none;
    }
  </style>
</head>

<body>
</body>

<script src="epic-poetry.js"></script>

<script>
  const settings = {
    corpus : [
      poems.iliad,
      poems.odyssey,
      poems.ramayana,
      poems.deRerumNatura,
      poems.aeneid,
      poems.metamorphoses,
      poems.beowulf,
      poems.theSongOfRoland,
      poems.nibelungenlied,
      poems.divineComedy,
      poems.paradiseLost,
      poems.kalevala,
      poems.idyllsOfTheKing,
    ],

    layers : 5,

    colors : ['#ff0000', '#00ff00', '#0000ff'],

    typingSpeed : {
      min : 1,
      max : 8,
    },

    blur : {
      probability : 0.9,

      default : {
        min : 0,
        max : 1,
      },

      altered : {
        min : 0,
        max : 8,
      },
    },

    jitter : {
      x : 1,
      y : 1,
    },

    delay : {
      style : {
        min : 100,
        max : 200,
      },

      character : {
        min :   0,
        max : 100,
      },
    },
  };

  const f = {
    randomIntegerInclusive : (min, max) => {
      min = Math.ceil(min);
      max = Math.floor(max);
      return Math.floor(Math.random() * (max - min + 1)) + min;
    },

    randomFloat : (min, max) => Math.random() * (max - min) + min,

    randomIntegerInRange : range => f.randomIntegerInclusive(range.min, range.max),
    randomFloatInRange   : range => f.randomFloat(range.min, range.max),

    randomItem : array => array[Math.floor(Math.random() * array.length)],

    rotateArray : (array, distance) => {
      const output = array.slice(0);

      for (let i = 0; i < distance; i++) {
        output.unshift(output.pop());
      }

      return output;
    },

    coin : p => Math.random() < p,
  };

  const styleBody = () => {
    const blur = settings.blur[f.coin(settings.blur.probability) ? 'default' : 'altered'];
    document.body.style.filter = 'blur(' + f.randomFloatInRange(blur) + 'px)';
    const delay = f.randomIntegerInRange(settings.delay.style);
    setTimeout(styleBody, delay);
  }

  const createLayers = layers => {
    settings.container = document.createElement('div');
    document.body.appendChild(settings.container);
    settings.container.id = 'container';

    const poem   = f.randomItem(settings.corpus);
    const offset = f.randomIntegerInclusive(0, poem.length - 1);

    settings.message = f.rotateArray(poem, offset).join(' ').split('');

    settings.texts = Array.from({length: layers}, () => {
      const p = document.createElement('p');
      settings.container.appendChild(p);

      const text = document.createElement('span');
      p.appendChild(text);
      text.className = 'text';

      const cursor = document.createElement('span');
      p.appendChild(cursor);
      cursor.className = 'cursor';
      cursor.innerHTML = '|';

      const style = () => {
        const [x, y] = [settings.jitter.x, settings.jitter.y].map(n => f.randomIntegerInclusive(...[-1, 1].map(s => n * s)));
        p.style.transform = 'translate(' + x + 'px, ' + y + 'px)';
        p.style.color = f.randomItem(settings.colors);
        const delay = f.randomIntegerInRange(settings.delay.style);
        setTimeout(style, delay);
      }

      style();
      return text;
    });
  }

  document.body.onkeypress = () => {
    let characters = f.randomIntegerInRange(settings.typingSpeed);

    const type = () => {
      if (characters > 0) {
        characters--;
        const next = settings.message.shift();

        settings.texts.forEach(text => {
          text.innerHTML += next;
        });

        const delay = f.randomIntegerInRange(settings.delay.character);
        setTimeout(type, delay);
      }
    }

    type();
    settings.container.scrollTop = settings.container.scrollHeight;
  }

  styleBody();
  createLayers(settings.layers);
</script>

</html>