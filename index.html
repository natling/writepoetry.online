<!DOCTYPE html>
<html>

<head>
  <title>write a poem</title>
  <meta charset="UTF-8">
  <link rel="shortcut icon" href="favicon.png"/>
  <style>
    body {
      margin: 0px;
      width: 100vw;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      background: black;
    }

    p {
      position: absolute;
      max-width: 70%;
      margin: 0px;
      text-align: justify;
      font-family: 'Courier';
      font-style: italic;
      font-size: 30px;
      letter-spacing: 5px;
      transition: transform 0.1s, color 0.1s;
      mix-blend-mode: color-dodge;
    }

    @keyframes blink {
      from { opacity: 0; }
      to   { opacity: 1; }
    }

    .cursor {
      animation: blink 0.5s ease infinite alternate;
    }
  </style>
</head>

<body>
</body>

<script src="epic-poetry.js"></script>

<script>
  var settings = {
    corpus : [
      poems.iliad,
      poems.odyssey,
      poems.ramayana,
      poems.deRerumNatura,
      poems.aeneid,
      poems.metamorphoses,
      poems.beowulf,
      poems.theSongOfRoland,
      poems.nibelungenlied,
      poems.divineComedy,
      poems.paradiseLost,
      poems.kalevala,
      poems.idyllsOfTheKing,
    ],

    layers : 5,

    colors : ['#ff0000', '#00ff00', '#0000ff'],

    lines : {
      min :  4,
      max : 12,
    },

    keystroke : {
      min : 1,
      max : 8,
    },

    blur : {
      probability : 0.9,

      default : {
        min : 0,
        max : 1,
      },

      altered : {
        min : 0,
        max : 8,
      },
    },

    jitter : {
      x : 1,
      y : 1,
    },

    delay : {
      style : {
        min : 100,
        max : 200,
      },

      character : {
        min :   0,
        max : 100,
      },
    },
  };

  var randomFloat = (min, max) => {
    return Math.random() * (max - min) + min;
  }

  var randomIntegerInclusive = (min, max) => {
    min = Math.ceil(min);
    max = Math.floor(max);
    return Math.floor(Math.random() * (max - min + 1)) + min;
  }

  var randomItem = array => {
    return array[Math.floor(Math.random() * array.length)];
  }

  var coin = p => Math.random() < p;

  var styleBody = () => {
    var blur = coin(settings.blur.probability) ? settings.blur.default : settings.blur.altered;
    document.body.style.filter = 'blur(' + randomFloat(blur.min, blur.max) + 'px)';
    var delay = randomIntegerInclusive(settings.delay.style.min, settings.delay.style.max);
    setTimeout(styleBody, delay);
  }

  var createLayers = () => {
    for (var i = 0; i < settings.layers; i++) {
      (i => {
        var p = document.createElement('p');
        document.body.appendChild(p);

        var text = document.createElement('span');
        p.appendChild(text);
        text.className = 'text';

        var cursor = document.createElement('span');
        p.appendChild(cursor);
        cursor.className = 'cursor';
        cursor.innerHTML = '|';

        var style = () => {
          var [x, y] = [settings.jitter.x, settings.jitter.y].map(n => randomIntegerInclusive(...[-1, 1].map(s => n * s)));
          p.style.transform = 'translate(' + x + 'px, ' + y + 'px)';
          p.style.color = randomItem(settings.colors);
          var delay = randomIntegerInclusive(settings.delay.style.min, settings.delay.style.max);
          setTimeout(style, delay);
        }

        style();
      })(i);
    }
  }

  var type = () => {
    if (settings.message === undefined) {
      var poem   = randomItem(settings.corpus);
      var lines  = randomIntegerInclusive(settings.lines.min, settings.lines.max);
      var offset = randomIntegerInclusive(0, poem.length - 1);
      settings.message = Array.from({length: lines}, (v, i) => poem[(i + offset) % poem.length]).join(' ');
    }

    var texts = document.getElementsByClassName('text');

    document.body.onkeypress = () => {
      var newCharacters = randomIntegerInclusive(settings.keystroke.min, settings.keystroke.max);

      for (var j = 0; j < newCharacters; j++) {
        for (var i = 0; i < texts.length; i++) {
          (i => {
            var addCharacter = () => {
              if (texts[i].innerHTML.length < settings.message.length) {
                texts[i].innerHTML = settings.message.slice(0, texts[i].innerHTML.length + 1);
              }
            }

            var delay = randomIntegerInclusive(settings.delay.character.min, settings.delay.character.max);
            setTimeout(addCharacter, delay);
          })(i);
        }
      }
    }
  }

  styleBody();
  createLayers();
  type();
</script>

</html>